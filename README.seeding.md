# База данных: инициализация и обновления

## Автоматическая инициализация

При первом запуске Postgres автоматически применяет все SQL-файлы из `db/init/` в алфавитном порядке.

**Главный файл:** `db/init/01_init.sql` — содержит полную схему БД и все демо-данные (рестораны, категории, блюда).

### Первый запуск

```bash
docker compose up --build
```

Postgres поднимется пустым и автоматически выполнит `01_init.sql`, создав:
- Всю схему БД (таблицы, последовательности, индексы, внешние ключи)
- Демо-данные (пользователи, рестораны, категории, 40+ блюд)
- Все изменения для "Smart Cart" (cart_token, delivery_slot, saved_carts, favorite_items и т.д.)

## Полное обнуление БД

Если нужно пересоздать БД с нуля:

```bash
docker compose down -v
docker compose up --build
```

Команда `down -v` удаляет все volumes, включая данные Postgres, поэтому при следующем `up` БД инициализируется заново.

## Особенности

- **Идемпотентность**: Все INSERT используют `ON CONFLICT DO NOTHING`, поэтому файл можно запускать повторно без ошибок.
- **Последовательности**: После вставки данных последовательности (sequences) автоматически обновляются до максимального ID.
- **Единый файл**: Вся схема и данные находятся в одном файле `01_init.sql` для простоты.

## Ручной запуск init-скрипта

Если нужно применить init-скрипт вручную на существующей БД:

```bash
docker compose exec postgres psql -U kasashka -d kasashka_db -f /docker-entrypoint-initdb.d/01_init.sql
```

**Примечание:** Docker entrypoint применяет init-скрипты только при первом запуске (когда БД пустая). Для повторного применения используйте команду выше.

## Миграции

Для изменений схемы после первого запуска используйте файлы в `db/migrations/`:

```bash
docker compose exec postgres psql -U kasashka -d kasashka_db -f /db/migrations/02_smart_cart.sql
```

**Важно:** Изменения схемы из миграций уже включены в `01_init.sql`, поэтому при чистой инициализации миграции не нужны.
